library(testthat)
library(dplyr)

extra_pair <- tidyr::tribble(
  ~author1,                                                                    ~author2,                                       ~author,  ~title1,                                                                                                 ~title2,                                                                                ~title,   ~abstract1,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ~abstract2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~abstract, ~year1,  ~year2,  ~year, ~number1, ~number2, ~number, ~pages1, ~pages2, ~pages, ~volume1, ~volume2, ~volume, ~journal1,          ~journal2,          ~journal, ~isbn, ~isbn1,       ~isbn2,       ~doi1,                      ~doi2,                      ~doi,     ~record_id1, ~record_id2, ~label1,    ~label2,    ~source1,  ~source2,  ~duplicate_id.x, ~duplicate_id.y, ~match, ~min_id, ~max_id,
  "Ferguson, MC and Waite, JM and Curtice, C and Clarke, JT and Harrison, J",  "Ferguson, MC and Curtice, C and Harrison, J",  0.85898,  "Biologically Important Areas for Cetaceans Within US Waters - Aleutian Islands and Bering Sea Region",  "Biologically Important Areas for Cetaceans Within US Waters - Gulf of Alaska Region",  0.92987,  "We integrated existing published and unpublished information to delineate Biologically Important Areas (BIAs) for bowhead, fin, gray, North Pacific right, and humpback whales and belugas in U.S. waters of the Aleutian Islands and Bering Sea. Supporting evidence for these BIAs came from aerial-, land-, and vessel-based surveys; satellite-tagging data; passive acoustic monitoring; traditional ecological knowledge; photo-and genetic-identification data; and whaling data, including catch and sighting locations and stomach contents. The geographic extent of the BIAs in this region ranged from approximately 1,200 to 373,000 km(2). Information gaps identified during this assessment include (1) reproductive areas for all species; (2) detailed information on the migration routes and timing of all species; and (3) cetacean distribution, density, and behavior in U.S. Bering Sea waters off the continental shelf. To maintain their utility, these BIAs should be re-evaluated and revised, if necessary, as new information becomes available.",  "We integrated existing published and unpublished information to delineate Biologically Important Areas (BIAs) for fin, gray, North Pacific right, and humpback whales, and belugas in U.S. waters of the Gulf of Alaska. BIAs are delineated for feeding, migratory corridors, and small and resident populations. Supporting evidence for these BIAs came from aerial-, land-, and vessel-based surveys; satellite-tagging data; passive acoustic monitoring; traditional ecological knowledge; photo-and genetic-identification data; whaling data, including catch and sighting locations and stomach contents; prey studies; and anecdotal information from fishermen. The geographic extent of the BIAs in this region ranged from approximately 900 to 177,000 km(2). Information gaps identified during this assessment include (1) reproductive areas for fin, gray, and North Pacific right whales; (2) detailed information on the migration routes of all species; (3) detailed information on the migratory timing of all species except humpback whales; and (4) cetacean distribution, density, and behavior in U.S. Gulf of Alaska waters off the continental shelf. To maintain their utility, these BIAs should be re-evaluated and revised, if necessary, as new information becomes available.",  0.88146,   "2015",  "2015",  1,     "1",      "1",      1,       "79",    "65",    0,      "41",     "41",     1,       "AQUATIC MAMMALS",  "AQUATIC MAMMALS",  1,        1,     "0167-5427",  "0167-5427",  "10.1578/AM.41.1.2015.79",  "10.1578/AM.41.1.2015.65",  0.96522,  "1036",      "1030",      "unknown",  "unknown",  "test_3",  "test_3",  "1036",          "1030",          FALSE,  "1030",  "1036"
)

auto_dedup <- tidyr::tribble(
  ~duplicate_id, ~record_ids,         ~author,                                                                     ~title,                                                                                                  ~year,   ~abstract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ~doi,                       ~volume, ~source,                   ~issue, ~issn,        ~start_page, ~file.name,    ~file.size, ~file.type, ~file.datapath,                                                                                 ~label,                       ~isbn,        ~journal,           ~pages, ~number, ~ID,
  "1030",        "1030, 1427, 2008",  "Ferguson, MC and Curtice, C and Harrison, J",                               "Biologically Important Areas for Cetaceans Within US Waters - Gulf of Alaska Region",                   "2015",  "We integrated existing published and unpublished information to delineate Biologically Important Areas (BIAs) for fin, gray, North Pacific right, and humpback whales, and belugas in U.S. waters of the Gulf of Alaska. BIAs are delineated for feeding, migratory corridors, and small and resident populations. Supporting evidence for these BIAs came from aerial-, land-, and vessel-based surveys; satellite-tagging data; passive acoustic monitoring; traditional ecological knowledge; photo-and genetic-identification data; whaling data, including catch and sighting locations and stomach contents; prey studies; and anecdotal information from fishermen. The geographic extent of the BIAs in this region ranged from approximately 900 to 177,000 km(2). Information gaps identified during this assessment include (1) reproductive areas for fin, gray, and North Pacific right whales; (2) detailed information on the migration routes of all species; (3) detailed information on the migratory timing of all species except humpback whales; and (4) cetacean distribution, density, and behavior in U.S. Gulf of Alaska waters off the continental shelf. To maintain their utility, these BIAs should be re-evaluated and revised, if necessary, as new information becomes available.",  "10.1578/AM.41.1.2015.65",  "41",    "test_3, test_2, test_1",  "1",    "0167-5427",  "65",        "test_3.ris",  "1343376",  "",         "/var/folders/xk/g0cqx1hs53z_txqsyq74jzcc0000gn/T//RtmpZgvaqg/0cf145f36dd8a17833ba383c/0.ris",  "unknown, unknown, unknown",  "0167-5427",  "AQUATIC MAMMALS",  "65",   "1",     "",
  "1036",        "1036, 1436, 2020",  "Ferguson, MC and Waite, JM and Curtice, C and Clarke, JT and Harrison, J",  "Biologically Important Areas for Cetaceans Within US Waters - Aleutian Islands and Bering Sea Region",  "2015",  "We integrated existing published and unpublished information to delineate Biologically Important Areas (BIAs) for bowhead, fin, gray, North Pacific right, and humpback whales and belugas in U.S. waters of the Aleutian Islands and Bering Sea. Supporting evidence for these BIAs came from aerial-, land-, and vessel-based surveys; satellite-tagging data; passive acoustic monitoring; traditional ecological knowledge; photo-and genetic-identification data; and whaling data, including catch and sighting locations and stomach contents. The geographic extent of the BIAs in this region ranged from approximately 1,200 to 373,000 km(2). Information gaps identified during this assessment include (1) reproductive areas for all species; (2) detailed information on the migration routes and timing of all species; and (3) cetacean distribution, density, and behavior in U.S. Bering Sea waters off the continental shelf. To maintain their utility, these BIAs should be re-evaluated and revised, if necessary, as new information becomes available.",                                                                                                                                                                                                                                    "10.1578/AM.41.1.2015.79",  "41",    "test_3, test_2, test_1",  "1",    "0167-5427",  "79",        "test_3.ris",  "1343376",  "",         "/var/folders/xk/g0cqx1hs53z_txqsyq74jzcc0000gn/T//RtmpZgvaqg/0cf145f36dd8a17833ba383c/0.ris",  "unknown, unknown, unknown",  "0167-5427",  "AQUATIC MAMMALS",  "79",   "1",     ""
)



# Test that label gets merged correctly when adding manual dedup
test_that("Adding manual pair merges record_ids", {
 expect_equal(
   dedup_citations_add_manual(auto_dedup, additional_pairs = extra_pair)$record_ids %>% unname(),
   "1030, 1427, 2008, 1036, 1436, 2020"
 )
})

test_that("Adding manual pair merges record_ids also with extra_merge_fields", {
  expect_equal(
    dedup_citations_add_manual(auto_dedup, additional_pairs = extra_pair, extra_merge_fields = "doi")$record_ids %>% unname(),
    "1030, 1427, 2008, 1036, 1436, 2020"
  )
})

# Longer test set - currently only used for manual testing of manual_dedup_shiny()
manual_test_set <- tidyr::tribble(
  ~author1,                                                                    ~author2,                                       ~author,  ~title1,                                                                                                 ~title2,                                                                                ~title,   ~abstract1,                                                                                     ~abstract2,                                                                                     ~abstract, ~year1,  ~year2,  ~year, ~number1, ~number2, ~number, ~pages1, ~pages2, ~pages, ~volume1, ~volume2, ~volume, ~journal1,          ~journal2,          ~journal, ~isbn, ~isbn1,       ~isbn2,       ~doi1,                      ~doi2,                      ~doi,     ~record_id1, ~record_id2, ~label1,    ~label2,    ~source1,  ~source2,  ~duplicate_id.x, ~duplicate_id.y, ~match, ~min_id, ~max_id,
  "Ferguson, MC and Waite, JM and Curtice, C and Clarke, JT and Harrison, J",  "Ferguson, MC and Curtice, C and Harrison, J",  0.85898,  "Biologically Important Areas for Cetaceans Within US Waters - Aleutian Islands and Bering Sea Region",  "Biologically Important Areas for Cetaceans Within US Waters - Gulf of Alaska Region",  0.92987,  "This study identifies Biologically Important Areas (BIAs) for cetaceans using surveys and data from U.S. waters in the Aleutian Islands and Bering Sea.",  "This study identifies Biologically Important Areas (BIAs) for cetaceans using surveys and data from U.S. waters in the Gulf of Alaska.",  0.88146,   "2015",  "2015",  1,     "1",      "1",      1,       "79",    "65",    0,      "41",     "41",     1,       "AQUATIC MAMMALS",  "AQUATIC MAMMALS",  1,        1,     "0167-5427",  "0167-5427",  "10.1578/AM.41.1.2015.79",  "10.1578/AM.41.1.2015.65",  0.96522,  "1036",      "1030",      "unknown",  "unknown",  "test_3",  "test_3",  "1036",          "1030",          FALSE,  "1030",  "1036",

  "Smith, J and Johnson, A",  "Smith, J and Adams, B",  0.90,  "Climate Change Effects on Marine Biodiversity",  "Impacts of Climate Change on Marine Life",  0.85,  "The study discusses the effects of climate change on marine biodiversity.",  "The study reviews how climate change impacts marine ecosystems.",  0.80,   "2020",  "2020",  1,     "2",      "2",      0,       "15",    "20",    0,      "32",     "32",     1,       "MARINE ECOLOGY",  "MARINE ECOLOGY",  1,        1,     "1234-5678",  "1234-5678",  "10.1000/ME.2020.15",  "10.1000/ME.2020.20",  0.92,  "2045",      "2046",      "true",  "true",  "source1",  "source2",  "2045",   "2046", TRUE,  "2045",  "2046",

  "Brown, P and Clark, D",  "Brown, P and Jones, F",  0.70,  "Renewable Energy Solutions",  "Renewable Energy Alternatives",  0.75,  "This paper explores different renewable energy solutions.",  "This paper explores alternative renewable energy sources.",  0.72,   "2019",  "2019",  1,     "5",      "5",      0,       "100",    "105",    0,      "50",     "50",     1,       "ENERGY STUDIES",  "ENERGY STUDIES",  1,        1,     "9876-5432",  "9876-5432",  "10.1000/ES.2019.100",  "10.1000/ES.2019.105",  0.85,  "3021",      "3022",      "false",  "false",  "source3",  "source4",  "3021",   "3022", FALSE,  "3021",  "3022",

  "Johnson, K and Liu, Y",  "Johnson, K and Liu, Z",  0.82,  "Advances in AI Research",  "Recent Advances in Artificial Intelligence",  0.78,  "This study presents recent developments in artificial intelligence research.",  "This paper reviews the recent advances in artificial intelligence.",  0.75,   "2018",  "2018",  1,     "3",      "3",      0,       "120",    "125",    0,      "60",     "60",     1,       "AI RESEARCH",  "AI RESEARCH",  1,        1,     "4321-6789",  "4321-6789",  "10.1000/AI.2018.120",  "10.1000/AI.2018.125",  0.88,  "4033",      "4034",      "true",  "true",  "source5",  "source6",  "4033",   "4034", TRUE,  "4033",  "4034",

  "Taylor, M and Green, A",  "Taylor, M and White, B",  0.60,  "Sustainable Agriculture in Developing Nations",  "Sustainable Agriculture in Africa",  0.65,  "This paper examines sustainable farming practices in developing countries.",  "This study focuses on sustainable agriculture in African nations.",  0.62,   "2017",  "2017",  1,     "4",      "4",      0,       "50",    "55",    0,      "30",     "30",     1,       "AGRICULTURE JOURNAL",  "AGRICULTURE JOURNAL",  1,        1,     "2468-1357",  "2468-1357",  "10.1000/AJ.2017.50",  "10.1000/AJ.2017.55",  0.72,  "5021",      "5022",      "false",  "false",  "source7",  "source8",  "5021",   "5022", FALSE,  "5021",  "5022"
)
